(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-fd34f1a6","chunk-f3d6cca6"],{"53dc":function(e,t,i){e.exports=i.p+"static/img/marker.a0c0c038.png"},6137:function(e,t,i){},"621d":function(e,t,i){"use strict";i("6f10")},"6f10":function(e,t,i){},8050:function(e,t,i){"use strict";i("6137")},"91e5":function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return e.queryParams?i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}]},[e.tableList.length>0?i("div",["card"===e.showType?i("el-row",{attrs:{gutter:10}},e._l(e.tableList,(function(t){return i("el-col",{key:t.addr,staticStyle:{"margin-bottom":"10px"},attrs:{xs:e.size[0],sm:e.size[1],md:e.size[2],lg:e.size[3],xl:e.size[4]}},[i("el-card",{staticClass:"box-card",attrs:{shadow:"hover"}},[i("div",{staticClass:"clearfix",attrs:{slot:"header"},slot:"header"},[i("span",[i("el-checkbox",{on:{change:function(i){return e.handleCardSelectionChange(i,t)}}}),i("el-button",{staticClass:"card-title",attrs:{type:"text"}},[e._v(e._s(t.name))])],1),i("div",{staticStyle:{float:"right"}},[e.isShow("netType")?i("dict-tag",{attrs:{options:e.dict.type.iot_net_type,value:t.product.netType}}):e._e()],1)]),i("el-container",[i("el-main",{staticStyle:{padding:"0px"}},[i("div",{staticClass:"card-row"},[e.isShow("nodeType")?i("dict-tag",{attrs:{options:e.dict.type.iot_node_type,value:t.product.nodeType}}):e._e(),"ezviz"!==t.product.category?i("span",[t.lastOnline?i("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"上线时间："+e.parseTime(t.lastOnline),placement:"bottom"}},[i("dict-tag",{attrs:{options:e.dict.type.iot_device_status,value:t.online}})],1):i("dict-tag",{attrs:{options:e.dict.type.iot_device_status,value:t.online}})],1):e._e(),e.isShow("status")&&"1"===t.status?i("el-tag",{attrs:{type:"danger"}},[e._v("禁用")]):e._e()],1),e.isShow("subAddr")?i("div",{staticClass:"card-row"},[i("span",{staticClass:"card-row-header"},[e._v("从站地址: ")]),e._v(e._s(t.subAddr)+" ")]):e._e(),i("div",{staticClass:"card-row"},[i("span",{staticClass:"card-row-header"},[e._v("设备地址: ")]),e._v(e._s(t.addr)+" ")]),e.isShow("project")?i("div",{staticClass:"card-row"},[i("span",{staticClass:"card-row-header"},[e._v("所属项目: ")]),e._v(e._s(e.formatRow(t,{property:"project"}))+" ")]):e._e(),e.isShow("product")?i("div",{staticClass:"card-row"},[i("span",{staticClass:"card-row-header"},[e._v("所属产品: ")]),e._v(e._s(t.product.name)+" ")]):e._e(),e.isShow("createTime")?i("div",{staticClass:"card-row"},[i("span",{staticClass:"card-row-header"},[e._v("创建时间: ")]),e._v(e._s(e.parseTime(t.createTime))+" ")]):e._e()]),i("el-aside",{staticStyle:{width:"80px","background-color":"unset",padding:"0px"}},[t.product&&t.product.img?i("ImagePreview",{attrs:{src:t.product.img}}):e._e()],1)],1),i("div",e._l(e.buttons,(function(n){return i("el-button",{key:n.event,attrs:{type:"text",icon:n.icon,"v-hasPermi":n.permission},on:{click:function(i){return e.handleClick(n.event,t)}}},[e._v(e._s(n.text))])})),1)],1)],1)})),1):i("el-table",{attrs:{data:e.tableList},on:{"selection-change":e.handleSelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"55",align:"center"}}),e.isShow("subAddr")?i("el-table-column",{key:"subAddr",attrs:{label:"从站地址",prop:"subAddr",align:"center"}}):e._e(),i("el-table-column",{key:"name",attrs:{label:"设备名称",prop:"name",align:"center"}}),i("el-table-column",{key:"addr",attrs:{label:"设备地址",prop:"addr",align:"center"}}),e.isShow("netType")?i("el-table-column",{attrs:{label:"连网类型",align:"center",prop:"netType"},scopedSlots:e._u([{key:"default",fn:function(t){return[i("dict-tag",{attrs:{options:e.dict.type.iot_net_type,value:t.row.product.netType}})]}}],null,!1,3527849428)}):e._e(),e.isShow("project")?i("el-table-column",{attrs:{label:"所属项目",align:"center",prop:"project",formatter:e.formatRow}}):e._e(),e.isShow("product")?i("el-table-column",{attrs:{label:"所属产品",align:"center",prop:"product"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(e._s(t.row.product.name))]}}],null,!1,1879660959)}):e._e(),e.isShow("nodeType")?i("el-table-column",{attrs:{label:"设备类型",align:"center",prop:"nodeType"},scopedSlots:e._u([{key:"default",fn:function(t){return[i("dict-tag",{attrs:{options:e.dict.type.iot_node_type,value:t.row.product.nodeType}})]}}],null,!1,3699797204)}):e._e(),e.isShow("status")?i("el-table-column",{attrs:{label:"是否启用",align:"center",width:"80"},scopedSlots:e._u([{key:"default",fn:function(t){return[i("el-switch",{attrs:{"active-value":"0","inactive-value":"1"},on:{change:function(i){return e.handleStatusChange(t.row)}},model:{value:t.row.status,callback:function(i){e.$set(t.row,"status",i)},expression:"scope.row.status"}})]}}],null,!1,3955094654)}):e._e(),e.isShow("online")?i("el-table-column",{key:"online",attrs:{label:"在线状态",prop:"online",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return["ezviz"===t.row.product.category?i("div",[e._v("-")]):i("div",[t.row.lastOnline?i("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"上线时间："+e.parseTime(t.row.lastOnline),placement:"bottom"}},[i("dict-tag",{attrs:{options:e.dict.type.iot_device_status,value:t.row.online}})],1):i("dict-tag",{attrs:{options:e.dict.type.iot_device_status,value:t.row.online}})],1)]}}],null,!1,3260477523)}):e._e(),e.isShow("createTime")?i("el-table-column",{attrs:{label:"创建时间",align:"center",prop:"createTime",width:"100"},scopedSlots:e._u([{key:"default",fn:function(t){return[i("span",[e._v(e._s(e.parseTime(t.row.createTime)))])]}}],null,!1,3078210614)}):e._e(),e.buttons.length>0?i("el-table-column",{attrs:{label:"操作",align:"center","class-name":"small-padding fixed-width"},scopedSlots:e._u([{key:"default",fn:function(t){return e._l(e.buttons,(function(n){return i("el-button",{key:n.event,attrs:{type:"text",icon:n.icon,"v-hasPermi":n.permission},on:{click:function(i){return e.handleClick(n.event,t.row)}}},[e._v(e._s(n.text))])}))}}],null,!1,49746620)}):e._e()],1),i("pagination",{directives:[{name:"show",rawName:"v-show",value:e.total>0,expression:"total>0"}],staticStyle:{"margin-bottom":"25px"},attrs:{total:e.total,page:e.queryParams.pageNum,limit:e.queryParams.pageSize},on:{"update:page":function(t){return e.$set(e.queryParams,"pageNum",t)},"update:limit":function(t){return e.$set(e.queryParams,"pageSize",t)},pagination:e.getList}})],1):i("el-empty",{attrs:{description:"暂无设备"}})],1):e._e()},a=[],s=(i("4de4"),i("d3b7"),i("b64b"),i("e9c4"),i("caad"),i("2532"),i("d81d"),i("a15b"),i("5a98")),r={dicts:["sys_normal_disable","iot_node_type","iot_device_status","iot_net_type"],components:{},props:{showType:{type:String,default:"card"},columns:{type:Array,default:function(){return[{key:"product",label:"所属产品",visible:!0},{key:"project",label:"所属项目",visible:!0},{key:"nodeType",label:"设备类型",visible:!0},{key:"netType",label:"协议类型",visible:!0},{key:"online",label:"在线状态",visible:!0},{key:"status",label:"是否启用",visible:!0},{key:"createTime",label:"创建时间",visible:!0}]}},refresh:{type:Boolean,default:!1},buttons:{type:Array,default:function(){return[]}},queryParams:{type:Object,default:function(){}},size:{type:Array,default:function(){return[24,12,8,8,6]}}},data:function(){return{loading:!1,table:"device",projects:[],total:0,tableList:[],selection:[]}},created:function(){this.getList()},methods:{isShow:function(e){var t=this.columns.filter((function(t){return t.key===e}));return t.length>0&&t[0].visible},getList:function(){if(this.queryParams){this.loading=!0;var e=this,t=JSON.parse(JSON.stringify(this.queryParams));t.pageNum=t.pageNum?t.pageNum:1,t.pageSize=t.pageSize?t.pageSize:10,t.gateway?(this.columns.includes("subAddr")||this.columns.push({key:"subAddr",label:"从站地址",visible:!0}),Object(s["d"])(t).then((function(t){var i=t.rows;e.formatTableList(e,t.total,i)}))):t.scene?Object(s["i"])(t).then((function(t){var i=t.rows;e.formatTableList(e,t.total,i)})):Object(s["k"])(this.table,t).then((function(t){var i=t.rows;e.formatTableList(e,t.total,i)}))}else this.tableList=[]},formatTableList:function(e,t,i){e.updateTableList(i,(function(n,a){i.map((function(e){var t=n.filter((function(t){return t.addr===e.addr})),i=a.filter((function(t){return t.id===e.product}));t&&t.length>0&&1===t[0].online?(e.online=1,e.lastOnline=t[0].connectTime):e.online=0,e.product=i&&i.length>0?i[0]:{}})),e.total=t,e.tableList=i,e.loading=!1}))},queryRelation:function(e,t,i){var n=[];t.length>0?Object(s["g"])(e,t.join(",")).then((function(e){var t=e.data;Array.isArray(t)?n=t:n.push(t),i(n)})).catch((function(e){i([])})):i(n)},updateTableList:function(e,t){var i=this,n=[],a=[],r=[];e.map((function(e){a.push(e.addr),e.product&&!n.includes(e.product)&&n.push(e.product),e.project&&!r.includes(e.project)&&r.push(e.project)})),Object(s["j"])(a.join(",")).then((function(e){var a=e.data;i.queryRelation("product",n,(function(e){i.queryRelation("project",r,(function(n){i.projects=n,t(a,e)}))}))}))},handleCardSelectionChange:function(e,t){e?this.selection.push(t):this.selection=this.selection.filter((function(e){return e.id!==t.id})),this.handleSelectionChange(this.selection),console.log(this.selection)},handleSelectionChange:function(e){var t={selection:e,tableList:this.tableList};this.$emit("handleSelectionChange",t)},handleStatusChange:function(e){return Object(s["l"])(this.table,{id:e.id,status:e.status})},handleClick:function(e,t){this.$emit("handleEvent",e,t)},formatRow:function(e,t){switch(t.property){case"project":if(e.project){var i=this.projects.filter((function(t){return t.id==e.project}));return i&&i[0]?i[0].title:"ID:"+e.project+" 无效"}return"未关联"}}},watch:{queryParams:function(){this.getList()},refresh:function(){this.getList()}}},o=r,c=(i("8050"),i("2877")),l=Object(c["a"])(o,n,a,!1,null,"37ee11c4",null);t["default"]=l.exports},ea75:function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}]},[i("MqttBoard",{attrs:{subscription:e.subscription},on:{doMqttMessage:e.doMqttMessage}}),i("el-row",{attrs:{gutter:10}},[e.edit?i("el-col",{staticClass:"mb8"},[i("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["system:scene:edit"],expression:"['system:scene:edit']"}],attrs:{type:"primary",icon:"el-icon-upload",size:"mini"},on:{click:function(t){e.openPicSelector=!0}}},[e.scene_data?i("span",[e._v("编辑")]):i("span",[e._v("上传全景图")])]),e.scene_data?i("el-button",{directives:[{name:"hasPermi",rawName:"v-hasPermi",value:["system:scene:edit"],expression:"['system:scene:edit']"}],attrs:{type:"primary",icon:"el-icon-edit",size:"mini"},on:{click:e.goAddMarker}},["start"===e.action?i("span",[e._v("开始锚点")]):e._e(),"stop"===e.action?i("span",[e._v("正在锚点，查看("+e._s(e.markers.length)+")")]):e._e()]):e._e()],1):e._e()],1),i("el-row",[e.scene_data?e._e():i("el-empty",{attrs:{description:"暂无全景图"}}),i("div",{attrs:{id:"viewBox"}})],1),i("el-dialog",{attrs:{title:"上传全景图",visible:e.openPicSelector},on:{"update:visible":function(t){e.openPicSelector=t}}},[i("el-form",{ref:"form",attrs:{model:e.form,"label-width":"100px"}},[i("el-form-item",{attrs:{label:"全景图"}},[i("ImageUpload",{attrs:{limit:1,value:e.form.path},on:{input:e.handleFile}})],1),i("el-form-item",{attrs:{label:"标题"}},[i("el-input",{model:{value:e.form.caption,callback:function(t){e.$set(e.form,"caption",t)},expression:"form.caption"}})],1),i("el-form-item",{attrs:{label:"宽度"}},[i("el-input",{model:{value:e.form.width,callback:function(t){e.$set(e.form,"width",t)},expression:"form.width"}})],1),i("el-form-item",{attrs:{label:"高度"}},[i("el-input",{model:{value:e.form.height,callback:function(t){e.$set(e.form,"height",t)},expression:"form.height"}})],1)],1),i("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[e.scene_data?i("el-button",{attrs:{size:"mini",icon:"el-icon-delete",type:"danger"},on:{click:e.deleteScene}},[e._v("删除")]):e._e(),i("el-button",{attrs:{size:"mini",icon:"el-icon-success",type:"primary"},on:{click:e.submitForm}},[e._v("保存")])],1)],1),i("el-dialog",{attrs:{title:"选择设备",visible:e.openSelectDevice,width:"55%"},on:{"update:visible":function(t){e.openSelectDevice=t}}},[i("DeviceTable",{attrs:{buttons:e.buttons,queryParams:e.queryParams},on:{handleEvent:e.onSelectDevice,handleSelectionChange:e.onSelectDevice}})],1),i("el-drawer",{attrs:{title:"当前已添加："+e.markers.length,visible:e.openAddPosition,size:"40%",direction:"rtl"},on:{"update:visible":function(t){e.openAddPosition=t}}},[i("el-card",{attrs:{shadow:"never"}},[i("el-collapse",{attrs:{accordion:""}},e._l(e.markers,(function(t){return i("el-collapse-item",{key:t.id,attrs:{name:t.id}},[i("template",{slot:"title"},[i("el-image",{attrs:{fit:"contain",src:e.defMarkerIcon}}),i("span",{staticClass:"collapse-title"},[e._v(e._s(t.id)+" "+e._s(t.listContent))])],1),i("div",[e._v("经度: "+e._s(t.longitude))]),i("div",[e._v("纬度: "+e._s(t.latitude))]),i("div",[e.showId===t.id?i("el-button",{attrs:{type:"text",icon:"el-icon-info",size:"mini"},on:{click:function(i){return e.hiddenMarker(t)}}},[e._v(" 隐藏 ")]):i("el-button",{attrs:{type:"text",icon:"el-icon-info",size:"mini"},on:{click:function(i){return e.selectMarker(t)}}},[e._v(" 显示 ")]),i("el-button",{attrs:{type:"text",icon:"el-icon-delete",size:"mini"},on:{click:function(i){return e.cleanMarker(t)}}},[e._v(" 删除 ")]),i("el-button",{attrs:{type:"text",icon:"el-icon-text",size:"mini"},on:{click:function(i){return e.selectDevice(t)}}},[e._v(" 选择设备 ")])],1)],2)})),1),i("div",{staticStyle:{"margin-top":"10px"}},[e.markers.length>0?i("el-button",{attrs:{type:"danger",icon:"el-icon-delete",size:"mini"},on:{click:e.cleanAllMarkers}},[e._v(" 清除 ")]):e._e(),i("el-button",{attrs:{type:"primary",icon:"el-icon-success",size:"mini"},on:{click:e.saveMarkers}},[e._v(" 保存 ")])],1)],1)],1)],1)},a=[],s=(i("b64b"),i("d81d"),i("b0c0"),i("e9c4"),i("4de4"),i("d3b7"),i("4c53"),i("4e82"),i("159b"),i("0ca4"),i("acb1"),i("e368")),r=i("245f"),o=i("5a98"),c=i("0835"),l=i("91e5"),d=i("fb77"),u={dicts:[],components:{MqttBoard:d["a"],DeviceTable:l["default"],ImageUpload:c["a"]},props:{scene:{type:Object,required:!0},scene_key:{type:String,required:!0},edit:{type:Boolean,default:!1}},data:function(){return{loading:!1,openPicSelector:!1,openAddPosition:!1,openSelectDevice:!1,form:{},scene_data:void 0,viewer:void 0,markersPlugin:void 0,markers:[],action:"start",showId:void 0,showAllTip:!0,currenMarker:void 0,defMarkerIcon:i("53dc"),queryParams:void 0,subscription:void 0,buttons:[{text:"选择设备",event:"selectDevice",icon:"el-icon-success"}]}},mounted:function(){this.sceneChange()},methods:{sub:function(){var e="s/out/"+this.scene.project+"/"+this.scene.id+"/#";this.subscription={topic:e,qos:0}},doMqttMessage:function(e,t){var i=JSON.parse(t);console.log(i),this.updateStatus()},hiddenMarker:function(e){this.markersPlugin.hideMarkerTooltip(e.id),this.showId=void 0},hiddenAllMarker:function(){var e=this;this.markers.map((function(t){e.hiddenMarker(t)}))},selectMarker:function(e){this.showId&&this.markersPlugin.hideMarkerTooltip(this.showId),this.openAddPosition=!1,this.showId=e.id,this.markersPlugin.gotoMarker(e.id),this.markersPlugin.showMarkerTooltip(e.id)},onSelectDevice:function(e,t){if("selectDevice"===e){this.openSelectDevice=!1,this.currenMarker.listContent=t.name;var i=this.currenMarker.tooltip;i.content=t.name,this.currenMarker.tooltip=i;var n=this.currenMarker.data;n||(n={devId:t.id}),n.addr=t.addr,this.currenMarker.data=n}},saveMarkers:function(){var e=this,t=this.scene_data.data,i=[];this.markers.map((function(e){var t={latitude:e.latitude,longitude:e.longitude};i.push({position:t,data:e.data,listContent:e.listContent})})),t.markers=i;var n={id:this.scene_data.id,data:JSON.stringify(t)};Object(o["l"])("scene_view",n).then((function(t){e.action="start",e.openAddPosition=!1,e.$modal.msgSuccess("保存成功!"),e.sceneChange()}))},cleanAllMarkers:function(){this.markersPlugin.clearMarkers(),this.markers=[]},cleanMarker:function(e){this.markersPlugin.removeMarker(e.id),this.markers=this.markers.filter((function(t){return t.id!==e.id}))},selectDevice:function(e){this.currenMarker=e,this.openSelectDevice=!0,this.queryParams={pageNum:1,pageSize:10,scene:this.scene.id},this.queryParams["orderby[desc]"]="createTime"},goAddMarker:function(){"start"===this.action?this.action="stop":this.openAddPosition=!0},reset:function(){this.showId=void 0,this.showAllTip=!1,this.currenMarker=void 0,this.scene_data=void 0,this.subscription={},this.form={},this.viewer&&(this.cleanAllMarkers(),this.viewer.destroy(),this.viewer=void 0)},sceneChange:function(){var e=this;this.reset();var t={scene:this.scene.id,sceneType:this.scene_key};this.loading=!0;var i=document.getElementById("viewBox");i.style.display="none",Object(o["k"])("scene_view",t).then((function(t){e.loading=!1;var n=t.data;if(n.length>0){e.sub(),e.scene_data=n[0];var a=e.scene_data.data;e.scene_data.data=JSON.parse(a),e.form=e.scene_data.data,e.transportMarkers(e.scene_data.data),i.style.display="block",e.createViewer(i)}}))},createViewer:function(e){var t=this,i=this.scene_data.data;this.viewer=new s["Viewer"]({container:e,panorama:i.path,navbar:["caption","zoom","move",{id:"showTipBtn",content:"显示/隐藏",title:"显示所有标记提示",className:"custom-button",onClick:function(e){t.markers.length>0&&(t.showAllTip?t.hiddenAllMarker():t.markersPlugin.showAllTooltips(),t.showAllTip=!t.showAllTip)}},"fullscreen","markersList"],caption:i.caption,mousewheel:!0,mousemove:!0,size:{width:i.width,height:i.height},plugins:[[r["MarkersPlugin"],{defaultHoverScale:!0,markers:this.markers}]]}),this.markersPlugin=this.viewer.getPlugin(r["MarkersPlugin"]),this.markersPlugin.on("select-marker",(function(e,i,n){var a=i.data;t.$emit("click",a.devId)})),this.viewer.once("ready",(function(){t.showAllTip=!0,t.markersPlugin.showAllTooltips()})),this.viewer.on("click",(function(e,i){if(!i.rightclick&&"stop"===t.action){var n=t.getId(),a={latitude:i.latitude,longitude:i.longitude},s=t.createMarker(n,a,"未绑定");t.markers.push(s),t.markersPlugin.addMarker(s)}}))},getId:function(){var e=0;try{var t=this.markers.sort((function(e,t){return e.id-t.id}));t.forEach((function(t){if(e+=1,t.id!==e)throw new Error("break")}))}catch(i){return e}return this.markers.length+1},createMarker:function(e,t,i,n){return{id:e,longitude:t.longitude,latitude:t.latitude,image:this.defMarkerIcon,width:32,height:32,anchor:"bottom center",tooltip:{content:i,className:"custom-tooltip",trigger:"click"},listContent:i,content:"<div>暂无数据</div>",data:n}},transportMarkers:function(e,t){var i=this,n=e.markers?e.markers:[],a=0;n.map((function(e){a+=1;var n=i.createMarker(a,e.position,e.listContent,e.data);t&&i.markersPlugin.addMarker(n),i.markers.push(n)}))},handleFile:function(e){this.form.path=e},updateStatus:function(){},deleteScene:function(){var e=this;Object(o["b"])("scene_view",this.scene_data.id).then((function(t){e.openPicSelector=!1,e.$modal.msgSuccess("删除成功!"),e.sceneChange()}))},submitForm:function(){var e=this,t={scene:this.scene.id,sceneType:this.scene_key,data:JSON.stringify(this.form)};this.scene_data?(t.id=this.scene_data.id,Object(o["l"])("scene_view",t).then((function(t){e.openPicSelector=!1,e.edit=!1,e.sceneChange(),e.$modal.msgSuccess("修改成功")}))):Object(o["a"])("scene_view",t).then((function(t){e.openPicSelector=!1,e.edit=!1,e.$modal.msgSuccess("创建成功"),e.sceneChange()}))}},watch:{scene:{deep:!0,handler:function(){this.sceneChange()}}}},p=u,h=(i("621d"),i("2877")),m=Object(h["a"])(p,n,a,!1,null,"f380b59a",null);t["default"]=m.exports}}]);